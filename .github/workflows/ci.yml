name: lab3

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  unit_tests:
    name: Run Unit Tests
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Display Python version
        run: |
          echo "Версия Python:"
          python3 --version
          which python3

      - name: Create virtual environment
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
    
      - name: Run tests
        run: |
          source venv/bin/activate
          echo "Запуск автоматических тестов..."
          python -m pytest tests/ -v
          echo "Тесты завершены успешно!"

  code_quality:
    name: Code Quality Check
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt 
          
      - name: Run code quality checks
        run: |
          source venv/bin/activate
          echo "Проверка качества кода..."
          pylint app/ tests/ --fail-under=7.0
          echo "Проверка стиля кода завершена!"

  deploy_demo:
    name: Deploy to Demo
    runs-on: self-hosted
    needs: [unit_tests, code_quality]  # Зависит от успеха предыдущих jobs
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy simulation
        run: |
          echo "ДЕПЛОЙ НА ПРОДУКТИВНЫЙ СЕРВЕР"
          echo "Версия: ${{ github.sha }}"
          echo "Образ: mortgage-calculator:${{ github.sha }}"
          echo "Всё стадии пройдены - код готов к развертыванию!"
          